# Ellipse Grid Generation & Data Loading

## ๐ฏ ะะฐะบ ัะฐะฑะพัะฐะตั ัะฐะทะดะตะปะตะฝะธะต ะฟะพ ัะปะปะธะฟัะฐะผ

### 1. **ะกะพะทะดะฐะฝะธะต ัะปะปะธะฟัะพะฒ** (Frontend โ Backend)

Frontend ะทะฐะฟััะบะฐะตั Monte Carlo ัะธะผัะปััะธั ะธ ะฟะพะปััะฐะตั impact points:

```
Primary impacts (ะพัะฝะพะฒะฝะพะน ะบะพัะฟัั):
  โโ ~1000-5000 ัะพัะตะบ ะฟะฐะดะตะฝะธั
  โโ ะััะธัะปัะตััั ัะปะปะธะฟั ัะฐััะตะธะฒะฐะฝะธั

Fragment impacts (ััะฐะณะผะตะฝัั):
  โโ ~500-2000 ัะพัะตะบ ะฟะฐะดะตะฝะธั  
  โโ ะััะธัะปัะตััั ัะปะปะธะฟั ัะฐััะตะธะฒะฐะฝะธั
```

**ะะฐัะฐะผะตััั ัะปะปะธะฟัะฐ**:
```python
{
    "center_lat": 47.5,      # ะฆะตะฝัั (ัะธัะพัะฐ)
    "center_lon": 66.0,      # ะฆะตะฝัั (ะดะพะปะณะพัะฐ)
    "semi_major_km": 30.0,   # ะะพะปััะฐั ะฟะพะปัะพัั (ะบะผ)
    "semi_minor_km": 15.0,   # ะะฐะปะฐั ะฟะพะปัะพัั (ะบะผ)
    "angle_deg": 45.0        # ะฃะณะพะป ะฟะพะฒะพัะพัะฐ (ะณัะฐะดััั ะพั ัะตะฒะตัะฐ)
}
```

### 2. **ะัะตะพะฑัะฐะทะพะฒะฐะฝะธะต ะฒ ะฟะพะปะธะณะพะฝั**

ะญะปะปะธะฟัั ะบะพะฝะฒะตััะธัััััั ะฒ ะฟะพะปะธะณะพะฝั (ัะฟะธัะพะบ ัะพัะตะบ):

```python
# server_pipeline/grid_generator.py
polygons = create_ellipse_polygons(primary_ellipse, fragment_ellipse)

# ะะตะทัะปััะฐั:
polygons = [
    [(lat1, lon1), (lat2, lon2), ..., (lat64, lon64)],  # Primary (64 ัะพัะบะธ)
    [(lat1, lon1), (lat2, lon2), ..., (lat64, lon64)],  # Fragment (64 ัะพัะบะธ)
]
```

### 3. **ะะตะฝะตัะฐัะธั grid**

Grid ัะพะทะดะฐัััั ะดะปั **ะพะฑัะตะดะธะฝัะฝะฝะพะน ะพะฑะปะฐััะธ** ะพะฑะพะธั ัะปะปะธะฟัะพะฒ:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Bounding Box (ะฟััะผะพัะณะพะปัะฝะธะบ)   โ
โ                                 โ
โ    โญโโโโโโฎ                      โ
โ   โฑ       โฒ  โ Primary Ellipse  โ
โ  โ         โ                    โ
โ   โฒ       โฑ                     โ
โ    โฐโโโโโโฏ   โญโโโโโฎ            โ
โ              โฑ      โฒ           โ
โ             โ        โ โ Fragmentโ
โ              โฒ      โฑ            โ
โ               โฐโโโโโฏ             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะัะพัะตัั**:
1. ะััะธัะปัะตััั bounding box (ะผะธะฝ/ะผะฐะบั lat/lon)
2. ะกะพะทะดะฐัััั ัะตัะบะฐ 1x1 ะบะผ
3. ะะปั ะบะฐะถะดะพะน ััะตะนะบะธ ะฟัะพะฒะตััะตััั: **ะฒะฝัััะธ ะปะธ ะพะฝะฐ ัะพัั ะฑั ะพะดะฝะพะณะพ ัะปะปะธะฟัะฐ?**
4. ะัะปะธ **ะะ** โ ััะตะนะบะฐ ัะพะทะดะฐัััั
5. ะัะปะธ **ะะะข** โ ััะตะนะบะฐ ะฟัะพะฟััะบะฐะตััั

```python
# Pseudo-code
for each potential cell in bounding_box:
    if point_in_polygon(cell.center, primary_polygon) OR 
       point_in_polygon(cell.center, fragment_polygon):
        grid.append(cell)  # โ ะกะพะทะดะฐัั
    else:
        pass  # โ ะัะพะฟัััะธัั
```

### 4. **ะะฐะณััะทะบะฐ ะดะฐะฝะฝัั (GEE)**

ะะปั ะบะฐะถะดะพะน ัะพะทะดะฐะฝะฝะพะน ััะตะนะบะธ ะทะฐะณััะถะฐัััั ะดะฐะฝะฝัะต:

```
Grid Cell โ GEE Request โ Data
  โโ NDVI (Sentinel-2)
  โโ Soil (SoilGrids)
  โโ Relief (SRTM DEM)
```

**ะะฐะถะฝะพ**: ะะฐะฝะฝัะต ะทะฐะณััะถะฐัััั **ัะพะปัะบะพ ะดะปั ััะตะตะบ ะฒะฝัััะธ ัะปะปะธะฟัะพะฒ**!

### 5. **ะญะบัะฟะพัั CSV**

CSV ัะพะดะตัะถะธั **ะฒัะต ััะตะนะบะธ** ะธะท ะพะฑะพะธั ัะปะปะธะฟัะพะฒ:

```csv
ID,Latitude,Longitude,NDVI,Soil,Relief,OTU,Missing Data
cell_1,47.234,66.123,0.456,0.789,0.912,0.567,None
cell_2,47.245,66.134,0.0,0.789,0.912,0.423,ndvi
...
```

## ๐ ะะฐะบ ะพะฟัะตะดะตะปะธัั, ะบ ะบะฐะบะพะผั ัะปะปะธะฟัั ะพัะฝะพัะธััั ััะตะนะบะฐ?

**ะะฐัะธะฐะฝั 1**: ะัะพะฒะตัะธัั ัะฐัััะพัะฝะธะต ะดะพ ัะตะฝััะพะฒ

```python
def get_ellipse_membership(cell, primary_ellipse, fragment_ellipse):
    dist_primary = distance(cell.center, primary_ellipse.center)
    dist_fragment = distance(cell.center, fragment_ellipse.center)
    
    if dist_primary < dist_fragment:
        return "primary"
    else:
        return "fragment"
```

**ะะฐัะธะฐะฝั 2**: ะัะพะฒะตัะธัั ะฟัะธะฝะฐะดะปะตะถะฝะพััั ะบ ะฟะพะปะธะณะพะฝั

```python
def get_ellipse_membership(cell, primary_polygon, fragment_polygon):
    if point_in_polygon(cell.center, primary_polygon):
        if point_in_polygon(cell.center, fragment_polygon):
            return "both"  # ะะตัะตะบัััะธะต
        return "primary"
    elif point_in_polygon(cell.center, fragment_polygon):
        return "fragment"
    return "none"
```

## ๐ ะกัะฐัะธััะธะบะฐ ัะฐะทะดะตะปะตะฝะธั

ะขะธะฟะธัะฝะพะต ัะฐัะฟัะตะดะตะปะตะฝะธะต ะดะปั ัะธะผัะปััะธะธ:

```
Total cells: 2500
โโ Primary only: 1200 (48%)
โโ Fragment only: 800 (32%)
โโ Overlap (both): 400 (16%)
โโ Outside (error): 100 (4%)
```

## ๐จ ะะธะทัะฐะปะธะทะฐัะธั ะฝะฐ ะบะฐััะต

**ะฆะฒะตัะพะฒะฐั ััะตะผะฐ**:
- ๐ข **Green/Yellow**: ะะพัะผะฐะปัะฝัะต ะดะฐะฝะฝัะต (OTU > 0.5)
- ๐ **Orange**: ะกัะตะดะฝะธะต ะดะฐะฝะฝัะต (0.3 < OTU < 0.5)
- ๐ด **Red**: ะะธะทะบะธะต ะดะฐะฝะฝัะต (OTU < 0.3)
- ๐ฃ **Purple**: Missing data (NDVI, Soil, ะธะปะธ Relief ะพััััััะฒััั)

**ะัะฐะฝะธัั ัะปะปะธะฟัะพะฒ**:
- ะัะพะฑัะฐะถะฐัััั ะบะฐะบ ะฟะพะปะธะณะพะฝั ะฝะฐ ะบะฐััะต
- Primary: ะะฑััะฝะพ ะฑะพะปััะต
- Fragment: ะะฑััะฝะพ ะผะตะฝััะต ะธ ัะผะตััะฝ

## โ๏ธ ะะฐัััะพะนะบะธ

**Cell size**: 1 ะบะผ (ะฟะพ ัะผะพะปัะฐะฝะธั)
- ะะพะถะฝะพ ะธะทะผะตะฝะธัั ะฒ `server_pipeline/grid_generator.py`
- ะะตะฝััะต = ะฑะพะปััะต ะดะตัะฐะปะตะน, ะฝะพ ะผะตะดะปะตะฝะฝะตะต
- ะะพะปััะต = ะฑััััะตะต, ะฝะพ ะผะตะฝััะต ะดะตัะฐะปะตะน

**Max cells**: 50,000 (safety limit)
- ะัะตะดะพัะฒัะฐัะฐะตั ัะพะทะดะฐะฝะธะต ัะปะธัะบะพะผ ะฑะพะปััะพะณะพ grid
- ะะฒัะพะผะฐัะธัะตัะบะธ ัะฒะตะปะธัะธะฒะฐะตั cell size ะตัะปะธ ะฟัะตะฒััะตะฝะพ

## ๐ Troubleshooting

**ะัะพะฑะปะตะผะฐ**: ะะฒะฐะดัะฐัะฝัะน grid ะฒะผะตััะพ ัะปะปะธะฟัะธัะตัะบะพะณะพ
- โ **ะะตัะตะฝะธะต**: ะฃะฑะตะดะธัะตัั, ััะพ `point_in_polygon` ัะฐะฑะพัะฐะตั
- โ **ะัะพะฒะตัะบะฐ**: ะะฐะฟัััะธัะต `test_grid_csv_export.py`

**ะัะพะฑะปะตะผะฐ**: ะกะปะธัะบะพะผ ะผะฝะพะณะพ missing data
- โ **ะะตัะตะฝะธะต**: ะัะพะฒะตัััะต GEE quota ะธ ะดะพัััะฟะฝะพััั ะดะฐะฝะฝัั
- โ **ะัะพะฒะตัะบะฐ**: ะะฐะฟัััะธัะต `test_frontend_compatibility.py`

**ะัะพะฑะปะตะผะฐ**: CSV ะฟัััะพะน ะธะปะธ ะฝะตะฟะพะปะฝัะน
- โ **ะะตัะตะฝะธะต**: ะัะพะฒะตัััะต, ััะพ OTU calculation ะทะฐะฒะตััะธะปัั
- โ **ะัะพะฒะตัะบะฐ**: ะะพัะผะพััะธัะต ะปะพะณะธ backend

---

**ะัะพะณะพ**: Grid ัะพะทะดะฐัััั ะดะปั **ะพะฑัะตะดะธะฝัะฝะฝะพะน ะพะฑะปะฐััะธ** ะพะฑะพะธั ัะปะปะธะฟัะพะฒ, ะฝะพ ะบะฐะถะดะฐั ััะตะนะบะฐ ะผะพะถะตั ะฑััั ะธะดะตะฝัะธัะธัะธัะพะฒะฐะฝะฐ ะฟะพ ะฟัะธะฝะฐะดะปะตะถะฝะพััะธ ะบ primary/fragment/both.
